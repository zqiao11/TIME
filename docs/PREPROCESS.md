# æ—¶é—´åºåˆ—é¢„å¤„ç† Pipeline æ–‡æ¡£

æœ¬æ–‡æ¡£è¯´æ˜ `timebench.preprocess` æ¨¡å—çš„åŠŸèƒ½å’Œä½¿ç”¨æ–¹æ³•ã€‚è¯¥æ¨¡å—ç”¨äºå¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œè´¨é‡æ£€æµ‹ã€æ¸…æ´—å’Œç»Ÿè®¡åˆ†æã€‚

---

## ç›®å½•

1. [æ¦‚è¿°](#1-æ¦‚è¿°)
2. [å¿«é€Ÿå¼€å§‹](#2-å¿«é€Ÿå¼€å§‹)
3. [å¤„ç†æµç¨‹](#3-å¤„ç†æµç¨‹)
4. [å‘½ä»¤è¡Œå‚æ•°](#4-å‘½ä»¤è¡Œå‚æ•°)
5. [è¾“å‡ºæ–‡ä»¶è¯´æ˜](#5-è¾“å‡ºæ–‡ä»¶è¯´æ˜)
6. [å†³ç­–ä¸æ•°æ®æ¸…ç†](#6-å†³ç­–ä¸æ•°æ®æ¸…ç†)
7. [ä¸‹ä¸€æ­¥](#7-ä¸‹ä¸€æ­¥)

---

## 1. æ¦‚è¿°

### åŠŸèƒ½

`PreprocessPipeline` å¯¹æ—¶é—´åºåˆ—æ•°æ®è¿›è¡Œä»¥ä¸‹å¤„ç†ï¼š

| åŠŸèƒ½ | è¯´æ˜ |
|------|------|
| **æ•°æ®ç±»å‹æ£€æŸ¥** | ç¡®ä¿æ•°æ®ä¸ºæ•°å€¼ç±»å‹ |
| **é•¿åº¦æ£€æŸ¥** | åŸºäºé¢‘ç‡è‡ªåŠ¨ç¡®å®šæœ€å°é•¿åº¦è¦æ±‚ |
| **ç¼ºå¤±å€¼æ£€æŸ¥** | æ£€æŸ¥ç¼ºå¤±ç‡ï¼Œ**ä¿ç•™åŸå§‹ NaN å€¼**ï¼ˆä¸è¿›è¡Œå¡«å……ï¼‰ |
| **å¸¸é‡åºåˆ—æ£€æµ‹** | æ£€æµ‹å¹¶ä¸¢å¼ƒå‡ ä¹ä¸å˜çš„åºåˆ— |
| **ç™½å™ªå£°æ£€æµ‹** | ä½¿ç”¨ Ljung-Box æ£€éªŒæ£€æµ‹çº¯å™ªå£°åºåˆ— |
| **éšæœºæ¸¸èµ°æ£€æµ‹** | ä½¿ç”¨ ADF æ£€éªŒæ£€æµ‹éšæœºæ¸¸èµ°ç‰¹æ€§ï¼ˆæ ‡è®° `[rw]`ï¼‰ |
| **å¼‚å¸¸å€¼æ£€æµ‹ä¸æ¸…æ´—** | åŸºäºæ»‘åŠ¨çª—å£ IQR æ–¹æ³•æ£€æµ‹å’Œæ¸…æ´—æç«¯å¼‚å¸¸å€¼ï¼Œ**å¼‚å¸¸å€¼æ›¿æ¢ä¸ºå‰ä¸€ä¸ªæ­£å¸¸å€¼**ï¼ˆä¸æ˜¯ NaNï¼‰ |
| **é«˜ç›¸å…³å˜é‡æ£€æµ‹** | æ£€æµ‹å˜é‡é—´çš„é«˜ç›¸å…³æ€§ï¼ˆé»˜è®¤é˜ˆå€¼ 0.95ï¼‰ |
| **æ•°æ®é›†çº§æ±‡æ€»ç»Ÿè®¡** | æ±‡æ€»å¤šä¸ª series çš„ç»Ÿè®¡ä¿¡æ¯ï¼Œè¾…åŠ©äººå·¥å†³ç­– |

### è¾“å‡ºæ ‡è®°

å¤„ç†åçš„å˜é‡åå¯èƒ½å¸¦æœ‰ä»¥ä¸‹æ ‡è®°ï¼š

| æ ‡è®° | å«ä¹‰ | è¯´æ˜ |
|------|------|------|
| `[rw]` | Random Walk | è¯¥å˜é‡åœ¨ ADF æ£€éªŒä¸­æœªèƒ½æ‹’ç»å•ä½æ ¹å‡è®¾ |
| `[sp]` | Spike Presence | è¯¥å˜é‡å­˜åœ¨è¾ƒå¤šç¬æ€å°–å³°ï¼ˆ>5%ï¼‰ |
| `[drop]` | å»ºè®®åˆ é™¤ | è¯¥å˜é‡ä¸ç¬¦åˆè¦æ±‚ï¼Œå»ºè®®åˆ é™¤ï¼ˆä»…åœ¨ `auto_drop=False` æ—¶æ˜¾ç¤ºï¼‰ |
| `[rw,sp]` | ä¸¤è€…çš†æœ‰ | åŒæ—¶å…·æœ‰éšæœºæ¸¸èµ°å’Œå°–å³°ç‰¹æ€§ |

---

## 2. å¿«é€Ÿå¼€å§‹
### åŸºæœ¬ç”¨æ³•

#### å•æ–‡ä»¶æ¨¡å¼ï¼›å³è¯¥æ•°æ®é›†ä»…æœ‰1ä¸ªcsvæ–‡ä»¶

```bash
python -m timebench.preprocess \
    --input_path /path/to/data.csv \
    --dataset MyDataset
```

#### å¤šæ–‡ä»¶æ¨¡å¼ï¼›å³è¯¥æ•°æ®é›†åŒ…å«å¤šä¸ªcsvæ–‡ä»¶

```bash
python -m timebench.preprocess \
    --input_path /path/to/csv_folder/ \
    --dataset IMOS \
    --freq 15T
```


---

## 3. å¤„ç†æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PreprocessPipeline å¤„ç†æµç¨‹                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 0: è§„èŒƒåŒ–æ—¶é—´æˆ³åˆ—                                                        â”‚
â”‚   - æ£€æŸ¥ç¬¬ä¸€åˆ—æ˜¯å¦ä¸ºæ—¶é—´æˆ³                                                     â”‚
â”‚   - è‡ªåŠ¨è¯†åˆ«åŒ…å« "time" æˆ– "date" çš„åˆ—                                        â”‚
â”‚   - é‡å‘½åä¸º "timestamp" å¹¶è®¾ä¸ºç´¢å¼•                                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: æ¨æ–­é¢‘ç‡å¹¶è®¾ç½®æœ€å°é•¿åº¦                                                 â”‚
â”‚   - è‡ªåŠ¨æ¨æ–­é¢‘ç‡ï¼ˆå¦‚ 15T, H, Dï¼‰                                              â”‚
â”‚   - æ ¹æ®é¢‘ç‡ç¡®å®š min_lengthï¼ˆå¦‚ 15T â†’ 2880 ç‚¹ â‰ˆ 30 å¤©ï¼‰                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step A: é€åˆ—å•å˜é‡æ£€æŸ¥ï¼ˆå¯¹æ¯ä¸ª variateï¼‰                                       â”‚
â”‚                                                                             â”‚
â”‚   æ•°æ®å¤„ç†ç­–ç•¥ï¼š                                                               â”‚
â”‚   - ä¿å­˜åŸå§‹åºåˆ—ï¼ˆä¿ç•™æ‰€æœ‰ NaNï¼‰                                              â”‚
â”‚   - ä¸ºéœ€è¦å®Œæ•´æ•°æ®çš„ checkï¼ˆå¦‚å¼‚å¸¸å€¼æ£€æµ‹ï¼‰ï¼Œä¸´æ—¶å¡«å…… NaN â†’ 0                  â”‚
â”‚   - æœ€ç»ˆä¿å­˜æ—¶ï¼Œå°†æ¸…æ´—ç»“æœæ˜ å°„å›åŸå§‹åºåˆ—ï¼Œä¿ç•™åŸå§‹ NaN                         â”‚
â”‚                                                                             â”‚
â”‚   â”œâ”€ æ•°æ®ç±»å‹æ£€æŸ¥ â†’ éæ•°å€¼ç±»å‹ â†’ âŒ ä¸¢å¼ƒ                                      â”‚
â”‚   â”œâ”€ é•¿åº¦æ£€æŸ¥ â†’ é•¿åº¦ < min_length â†’ âŒ ä¸¢å¼ƒ                                  â”‚
â”‚   â”œâ”€ ç¼ºå¤±ç‡æ£€æŸ¥ â†’ ç¼ºå¤±ç‡ > é˜ˆå€¼ â†’ âŒ ä¸¢å¼ƒ             â”‚
â”‚   â”œâ”€ æ—¶é—´æˆ³æ£€æŸ¥ â†’ éå•è°ƒé€’å¢ â†’ âŒ ä¸¢å¼ƒ                                        â”‚
â”‚   â”œâ”€ å¸¸é‡æ£€æµ‹ â†’ Top-5 å€¼å æ¯” > 50% ä¸”ç†µ < 0.1 â†’ âŒ ä¸¢å¼ƒ                       â”‚
â”‚   â”œâ”€ ç™½å™ªå£°æ£€æµ‹ â†’ Ljung-Box p > 0.05 â†’ âŒ ä¸¢å¼ƒ                               â”‚
â”‚   â”œâ”€ éšæœºæ¸¸èµ°æ£€æµ‹ â†’ ADF p > 0.05 â†’ æ ‡è®° [rw]ï¼ˆä¸ä¸¢å¼ƒï¼‰                        â”‚
â”‚   â””â”€ å¼‚å¸¸å€¼æ£€æµ‹ â†’ æç«¯å¼‚å¸¸ > 5% â†’ âŒ ä¸¢å¼ƒ                                     â”‚
â”‚                  â†’ æç«¯å¼‚å¸¸ â‰¤ 5% â†’ æ¸…æ´—å¼‚å¸¸ç‚¹ï¼ˆç”¨å‰ä¸€ä¸ªæ­£å¸¸å€¼æ›¿æ¢ï¼‰         â”‚
â”‚                  â†’ ç¬æ€å°–å³° > 5% â†’ æ ‡è®° [sp]ï¼ˆä¸ä¸¢å¼ƒï¼‰                         â”‚
â”‚                                                                             â”‚
â”‚   å¤„ç†æ¨¡å¼ï¼š                                                                  â”‚
â”‚   - auto_drop=Falseï¼ˆé»˜è®¤ï¼‰ï¼šæ‰€æœ‰åˆ—éƒ½ä¿ç•™ï¼Œä¸ç¬¦åˆè¦æ±‚çš„åˆ—æ ‡è®°ä¸º [drop]          â”‚
â”‚   - auto_drop=Trueï¼šä¸ç¬¦åˆè¦æ±‚çš„åˆ—ç›´æ¥åˆ é™¤ï¼Œä¸ä¿ç•™åœ¨è¾“å‡ºä¸­                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step B: å¤šå˜é‡æ£€æŸ¥                                                           â”‚
â”‚   - è®¡ç®— Pearson ç›¸å…³ç³»æ•°çŸ©é˜µ                                                 â”‚
â”‚   - æ ‡è®° |r| > 0.95 çš„å˜é‡å¯¹ä¸º correlation_duplicates                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¾“å‡º                                                                         â”‚
â”‚   - æ¸…æ´—åçš„ CSV æ–‡ä»¶                                                         â”‚
â”‚     * ä¿ç•™åŸå§‹ NaN å€¼ï¼ˆä¸è¿›è¡Œå¡«å……ï¼‰                                            â”‚
â”‚     * å¼‚å¸¸å€¼æ›¿æ¢ä¸ºå‰ä¸€ä¸ªæ­£å¸¸å€¼                                      â”‚
â”‚     * auto_drop=True æ—¶ï¼šä¸ç¬¦åˆè¦æ±‚çš„åˆ—å·²åˆ é™¤                                  â”‚
â”‚     * auto_drop=False æ—¶ï¼šæ‰€æœ‰åˆ—éƒ½ä¿ç•™ï¼Œä¸ç¬¦åˆè¦æ±‚çš„åˆ—æ ‡è®°ä¸º [drop]              â”‚
â”‚   - è¯¦ç»†ç»“æœ JSON æ–‡ä»¶ï¼ˆæ¯ä¸ª series ä¸€ä¸ªï¼‰                                      â”‚
â”‚     * åŒ…å« num_observationsï¼ˆé NaN å€¼æ€»æ•°ï¼‰                                   â”‚
â”‚     * ç»Ÿè®¡å€¼åŸºäºæœ€ç»ˆè¾“å‡ºçš„ cleaned_df è®¡ç®—ï¼ˆauto_drop=True æ—¶ä¸ºåˆ é™¤åçš„æ•°æ®ï¼‰     â”‚
â”‚   - æ•°æ®é›†çº§æ±‡æ€» JSONï¼ˆ`_summary.json`ï¼Œä»…å¤šæ–‡ä»¶æ¨¡å¼ï¼‰                          â”‚
â”‚     * åŒ…å«æ•°æ®é›†çº§åˆ«çš„ç»Ÿè®¡ä¿¡æ¯ï¼ˆnum_observationsã€series é•¿åº¦ç­‰ï¼‰                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ•°æ®å¤„ç†ç­–ç•¥è¯´æ˜

#### Missing Value (NaN) å¤„ç†

- **æ£€æŸ¥é˜¶æ®µ**ï¼šä¸ºäº†è¿›è¡Œéœ€è¦å®Œæ•´æ•°æ®çš„ checkï¼ˆå¦‚å¼‚å¸¸å€¼æ£€æµ‹ã€å¸¸é‡æ£€æµ‹ç­‰ï¼‰ï¼Œç³»ç»Ÿä¼šä¸´æ—¶å°† NaN å¡«å……ä¸º 0
- **æœ€ç»ˆä¿å­˜**ï¼š**åŸå§‹ NaN å€¼ä¼šè¢«å®Œæ•´ä¿ç•™**ï¼Œä¸ä¼šè¿›è¡Œä»»ä½•å¡«å……æˆ–æ’å€¼å¤„ç†
- **åŸå› **ï¼šæŸäº›ç»Ÿè®¡æ£€éªŒï¼ˆå¦‚å¼‚å¸¸å€¼æ£€æµ‹çš„ rolling æ“ä½œï¼‰éœ€è¦å®Œæ•´æ•°æ®æ‰èƒ½å‡†ç¡®è®¡ç®—ï¼Œä½†æœ€ç»ˆè¾“å‡ºåº”ä¿ç•™åŸå§‹ç¼ºå¤±ä¿¡æ¯

#### å¼‚å¸¸å€¼å¤„ç†

- **æ£€æµ‹æ–¹æ³•**ï¼šåŸºäºæ»‘åŠ¨çª—å£ IQRï¼ˆå››åˆ†ä½è·ï¼‰æ–¹æ³•ï¼ŒåŒºåˆ†ä¸¤ç±»å¼‚å¸¸ï¼š
  - **Transient Spikesï¼ˆç¬æ€å°–å³°ï¼‰**ï¼šåç¦»å±€éƒ¨åˆ†å¸ƒä½†å±äºæ­£å¸¸æ—¶é—´ç‰¹æ€§çš„ç‚¹ï¼ˆå¦‚å‘¨æœŸæ€§å³°å€¼ï¼‰ï¼Œä»…æ ‡è®° `[sp]`ï¼Œä¸åˆ é™¤
  - **Extreme Outliersï¼ˆæç«¯å¼‚å¸¸ï¼‰**ï¼šæ˜æ˜¾é”™è¯¯çš„æ•°æ®ç‚¹
    - å¦‚æœæ¯”ä¾‹ > 5%ï¼šç›´æ¥ä¸¢å¼ƒè¯¥ variate
    - å¦‚æœæ¯”ä¾‹ â‰¤ 5%ï¼š**æ›¿æ¢ä¸ºå‰ä¸€ä¸ªæ­£å¸¸å€¼**ï¼ˆä¸æ˜¯ NaNï¼‰
- **æœ€ç»ˆä¿å­˜**ï¼šå¼‚å¸¸å€¼è¢«æ›¿æ¢ä¸ºå‰ä¸€ä¸ªæ­£å¸¸å€¼ï¼ŒåŸå§‹ NaN ä¿æŒä¸å˜

#### æœ€ç»ˆ CSV æ–‡ä»¶å†…å®¹

- âœ… **åŸå§‹ NaN å€¼**ï¼šå®Œæ•´ä¿ç•™
- âœ… **å¼‚å¸¸å€¼**ï¼šæ›¿æ¢ä¸ºå‰ä¸€ä¸ªæ­£å¸¸å€¼ï¼ˆä¸æ˜¯ NaNï¼‰
- âœ… **å…¶ä»–æ•°æ®**ï¼šä¿æŒä¸å˜

---

## 4. å‘½ä»¤è¡Œå‚æ•°

### ä¸»å¤„ç†æ¨¡å¼

```bash
python -m timebench.preprocess \
    --input_path <è·¯å¾„> \
    --dataset <æ•°æ®é›†åç§°> \
    [--freq <é¢‘ç‡>] \
    [--missing_rate_thresh <é˜ˆå€¼>] \
    [--output_dir <è¾“å‡ºç›®å½•>] \
    [--auto_drop]
```

| å‚æ•° | å¿…éœ€ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--input_path` | âœ… | - | CSV æ–‡ä»¶æˆ–æ–‡ä»¶å¤¹è·¯å¾„ |
| `--dataset` | âœ… | - | æ•°æ®é›†åç§°ï¼ˆç”¨äºè¾“å‡ºæ–‡ä»¶å‘½åï¼‰ |
| `--freq` | âŒ | è‡ªåŠ¨æ¨æ–­ | æ—¶é—´åºåˆ—é¢‘ç‡ï¼Œå¦‚ `H`, `15T`, `D` |
| `--missing_rate_thresh` | âŒ | 0.3 | æœ€å¤§å…è®¸ç¼ºå¤±ç‡ |
| `--output_dir` | âŒ | `./data` | è¾“å‡ºæ ¹ç›®å½• |
| `--auto_drop` | âŒ | False | è‡ªåŠ¨åˆ é™¤ä¸ç¬¦åˆè¦æ±‚çš„åˆ—ã€‚é»˜è®¤ Falseï¼ˆä»…æ£€æŸ¥ä¸åˆ é™¤ï¼‰ï¼Œæ‰€æœ‰åˆ—éƒ½ä¼šä¿ç•™åœ¨è¾“å‡ºä¸­ï¼Œä½†ä¼šæ ‡è®°å»ºè®®åˆ é™¤çš„åˆ— |

### å¤„ç†æ¨¡å¼è¯´æ˜

#### é»˜è®¤æ¨¡å¼ï¼ˆ`auto_drop=False`ï¼‰

- **è¡Œä¸º**ï¼šä»…æ£€æŸ¥ä¸åˆ é™¤ï¼Œæ‰€æœ‰åˆ—éƒ½ä¼šä¿ç•™åœ¨è¾“å‡º CSV ä¸­
- **æ ‡è®°**ï¼šä¸ç¬¦åˆè¦æ±‚çš„åˆ—ä¼šè¢«æ ‡è®°ä¸º `[drop]`
- **ç”¨é€”**ï¼šé€‚åˆéœ€è¦æŸ¥çœ‹æ‰€æœ‰æ£€æŸ¥ç»“æœï¼Œç„¶åæ ¹æ® summary æ‰‹åŠ¨å†³å®šåˆ é™¤å“ªäº›åˆ—çš„åœºæ™¯
- **ç»Ÿè®¡å€¼**ï¼šJSON ä¸­çš„ç»Ÿè®¡å€¼ï¼ˆå¦‚ `num_observations`ã€`n_cols` ç­‰ï¼‰åŸºäºåŒ…å«æ‰€æœ‰åˆ—çš„æ•°æ®è®¡ç®—

#### è‡ªåŠ¨åˆ é™¤æ¨¡å¼ï¼ˆ`auto_drop=True`ï¼‰

- **è¡Œä¸º**ï¼šè‡ªåŠ¨åˆ é™¤ä¸ç¬¦åˆè¦æ±‚çš„åˆ—ï¼Œä¸ä¿ç•™åœ¨è¾“å‡º CSV ä¸­
- **æ ‡è®°**ï¼šä¸ä¼šå‡ºç° `[drop]` æ ‡è®°ï¼ˆå› ä¸ºä¸ç¬¦åˆè¦æ±‚çš„åˆ—å·²è¢«åˆ é™¤ï¼‰
- **ç”¨é€”**ï¼šé€‚åˆå¸Œæœ›ç›´æ¥è·å¾—æ¸…æ´—åæ•°æ®ï¼Œä¸éœ€è¦æ‰‹åŠ¨å†³ç­–çš„åœºæ™¯
- **ç»Ÿè®¡å€¼**ï¼šJSON ä¸­çš„ç»Ÿè®¡å€¼åŸºäºåˆ é™¤åçš„æ•°æ®è®¡ç®—

---

## 5. è¾“å‡ºæ–‡ä»¶è¯´æ˜

### å•ä¸ª Series çš„ JSON æ–‡ä»¶

æ¯ä¸ªå¤„ç†åçš„ CSV æ–‡ä»¶å¯¹åº”ä¸€ä¸ª JSON æ–‡ä»¶ï¼ˆå¦‚ `item_0.json`ï¼‰ï¼ŒåŒ…å«ä»¥ä¸‹ä¿¡æ¯ï¼š

#### `_meta` å­—æ®µ

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `inferred_freq` | æ¨æ–­çš„æ—¶é—´åºåˆ—é¢‘ç‡ |
| `min_length` | æœ€å°é•¿åº¦è¦æ±‚ |
| `n_rows` | è¡Œæ•°ï¼ˆæ—¶é—´ç‚¹æ•°é‡ï¼‰ |
| `n_cols` | åˆ—æ•°ï¼ˆå˜é‡æ•°é‡ï¼‰ |
| `shape` | DataFrame å½¢çŠ¶ `[n_rows, n_cols]` |
| `original_columns` | åŸå§‹åˆ—ååˆ—è¡¨ |
| `kept_columns` | ä¿ç•™çš„åˆ—ååˆ—è¡¨ï¼ˆå¸¦æ ‡è®°ï¼‰ |
| `dropped_columns` | å®é™…è¢«åˆ é™¤çš„åˆ—ï¼ˆä»…åœ¨ `auto_drop=True` æ—¶ï¼‰ |
| `recommended_drop_columns` | å»ºè®®åˆ é™¤çš„åˆ—ï¼ˆæ£€æŸ¥ç»“æœï¼‰ |
| `auto_drop` | æ˜¯å¦å¯ç”¨äº†è‡ªåŠ¨åˆ é™¤æ¨¡å¼ |
| `num_observations` | **é NaN å€¼çš„æ€»æ•°**ï¼ˆNaN ä¸è®¡å…¥ observationsï¼‰ |
| `spike_presence_columns` | å…·æœ‰ `[sp]` æ ‡è®°çš„åˆ— |
| `random_walk_columns` | å…·æœ‰ `[rw]` æ ‡è®°çš„åˆ— |
| `drop_marked_columns` | å…·æœ‰ `[drop]` æ ‡è®°çš„åˆ—ï¼ˆä»…åœ¨ `auto_drop=False` æ—¶ï¼‰ |

#### å„å˜é‡çš„æ£€æŸ¥ç»“æœ

æ¯ä¸ªå˜é‡åŒ…å«ï¼š
- `predictable`: æ˜¯å¦å¯é¢„æµ‹ï¼ˆæ˜¯å¦é€šè¿‡æ£€æŸ¥ï¼‰
- `checks`: æ£€æŸ¥ç»“æœåˆ—è¡¨
- `has_spike_presence`: æ˜¯å¦æœ‰å°–å³°ç‰¹æ€§
- `is_random_walk`: æ˜¯å¦ä¸ºéšæœºæ¸¸èµ°
- `outlier_stats`: å¼‚å¸¸å€¼ç»Ÿè®¡ä¿¡æ¯

**æ³¨æ„**ï¼š
- `multivariate` å­—æ®µï¼ˆç›¸å…³æ€§çŸ©é˜µï¼‰**ä¸ä¼šä¿å­˜**åˆ° JSON æ–‡ä»¶ä¸­ï¼Œä»¥å‡å°æ–‡ä»¶å¤§å°
- `cleaned_ts` å­—æ®µï¼ˆæ¸…æ´—åçš„æ—¶é—´åºåˆ—ï¼‰**ä¸ä¼šä¿å­˜**åˆ° JSON æ–‡ä»¶ä¸­

### æ•°æ®é›†çº§æ±‡æ€»æ–‡ä»¶ï¼ˆ`_summary.json`ï¼‰

**ä»…å½“æ•°æ®é›†åŒ…å«å¤šä¸ª series æ—¶**ï¼Œä¼šç”Ÿæˆ `_summary.json` æ–‡ä»¶ã€‚

#### åŸºæœ¬ä¿¡æ¯

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `dataset` | æ•°æ®é›†åç§° |
| `freq` | æ—¶é—´åºåˆ—é¢‘ç‡ |
| `num_series` | Series æ•°é‡ |
| `success_count` | æˆåŠŸå¤„ç†çš„ Series æ•°é‡ |

#### æ•°æ®é›†çº§åˆ«ç»Ÿè®¡ï¼ˆä»…å½“ `num_series > 1` æ—¶ï¼‰

| å­—æ®µ | è¯´æ˜ |
|------|------|
| `num_observations` | æ‰€æœ‰ series çš„é NaN observations æ€»å’Œ |
| `max_series_length` | æœ€é•¿çš„ series é•¿åº¦ |
| `min_series_length` | æœ€çŸ­çš„ series é•¿åº¦ |
| `avg_series_length` | å¹³å‡ series é•¿åº¦ |

#### Variates ç»Ÿè®¡

æ¯ä¸ª variate åŒ…å«ï¼š
- `total`: å‡ºç°åœ¨å¤šå°‘ä¸ª series ä¸­
- `kept`: åœ¨å¤šå°‘ä¸ª series ä¸­è¢«ä¿ç•™
- `rw`: åœ¨å¤šå°‘ä¸ª series ä¸­è¢«æ ‡è®°ä¸ºéšæœºæ¸¸èµ°
- `sp`: åœ¨å¤šå°‘ä¸ª series ä¸­è¢«æ ‡è®°ä¸ºæœ‰å°–å³°
- `kept_ratio`, `rw_ratio`, `sp_ratio`: å¯¹åº”çš„æ¯”ä¾‹
- `dropped_series`: è¢«ä¸¢å¼ƒçš„ series åˆ—è¡¨
- `kept_series`: è¢«ä¿ç•™çš„ series åˆ—è¡¨

**æ³¨æ„**ï¼š
- `correlation_duplicates` å­—æ®µ**ä¸ä¼šä¿å­˜**åˆ° `_summary.json` ä¸­
- ç›¸å…³æ€§ä¿¡æ¯ä»…ç”¨äºæ‰“å°è¾“å‡ºï¼Œä¸ä¿å­˜åˆ°æ–‡ä»¶

---

## 6. å†³ç­–ä¸æ•°æ®æ¸…ç†

### å†³ç­–æç¤º

å¤„ç†å®Œæˆåï¼Œç³»ç»Ÿä¼šæ ¹æ®ç»Ÿè®¡ç»“æœç”Ÿæˆå†³ç­–æç¤ºï¼š

```
âš ï¸  [å†³ç­–æç¤º] éœ€è¦äººå·¥å†³ç­–!
============================================================

ğŸ“Œ ä»¥ä¸‹ variate åœ¨å¤šæ•° series ä¸Šè¢«ä¸¢å¼ƒï¼Œå»ºè®®ä»æ•´ä¸ªæ•°æ®é›†ä¸­ç§»é™¤è¯¥ variate:
   - TURB: ä»…åœ¨ 3/8 ä¸ª series ä¸Šä¿ç•™ (ä¸¢å¼ƒç‡ 62.5%)
     è¢«ä¸¢å¼ƒçš„ series: item_2.csv, item_5.csv, item_7.csv

   æ‰¹é‡ç§»é™¤å‘½ä»¤: python -m timebench.preprocess --remove_variate TURB --target_dir ./data/processed_csv/IMOS/15T

ğŸ“Œ ä»¥ä¸‹ variate ä»…åœ¨å°‘æ•° series ä¸Šè¢«ä¸¢å¼ƒï¼Œå»ºè®®ç§»é™¤é‚£äº› series:
   - DOX2: åœ¨ 1/8 ä¸ª series ä¸Šè¢«ä¸¢å¼ƒ
     è¢«ä¸¢å¼ƒçš„ series: item_7.csv

   æ‰¹é‡ç§»é™¤å‘½ä»¤: python -m timebench.preprocess --remove_series item_7.csv --target_dir ./data/processed_csv/IMOS/15T

ğŸ“Œ ä»¥ä¸‹å˜é‡å¯¹åœ¨å¤šæ•° series ä¸Šé«˜åº¦ç›¸å…³ï¼Œè€ƒè™‘ç§»é™¤å…¶ä¸­ä¸€ä¸ª:
   - CNDC <-> TEMP: åœ¨ 5/8 ä¸ª series ä¸Šé«˜ç›¸å…³
     rå‡å€¼: é«˜ç›¸å…³=0.9888, éé«˜ç›¸å…³=0.7181, å…¨éƒ¨=0.8873
     ç§»é™¤ CNDC: python -m timebench.preprocess --remove_variate CNDC --target_dir ...
     ç§»é™¤ TEMP: python -m timebench.preprocess --remove_variate TEMP --target_dir ...
```

### å†³ç­–åŸåˆ™

| æƒ…å†µ | å»ºè®®æ“ä½œ | å‘½ä»¤ |
|------|----------|------|
| Variate åœ¨ â‰¥50% series ä¸Šè¢«ä¸¢å¼ƒ | ä»æ•´ä¸ªæ•°æ®é›†ç§»é™¤è¯¥ variate | `--remove_variate` |
| Variate åœ¨ <50% series ä¸Šè¢«ä¸¢å¼ƒ | ç§»é™¤é‚£äº› series | `--remove_series` |
| ä¸¤ä¸ªå˜é‡é«˜åº¦ç›¸å…³ï¼ˆr > 0.95ï¼‰ | æ ¹æ®ä¸šåŠ¡æ„ä¹‰ä¿ç•™ä¸€ä¸ª | `--remove_variate` |

### ç›¸å…³ç³»æ•°è¯´æ˜

| æŒ‡æ ‡ | è¯´æ˜ |
|------|------|
| `rå‡å€¼(é«˜)` | åœ¨é«˜ç›¸å…³ seriesï¼ˆr > 0.95ï¼‰ä¸Šçš„å¹³å‡ç›¸å…³ç³»æ•° |
| `rå‡å€¼(ä½)` | åœ¨éé«˜ç›¸å…³ seriesï¼ˆr â‰¤ 0.95ï¼‰ä¸Šçš„å¹³å‡ç›¸å…³ç³»æ•° |
| `rå‡å€¼(å…¨)` | åœ¨æ‰€æœ‰ series ä¸Šçš„å¹³å‡ç›¸å…³ç³»æ•° |

### æ‰¹é‡åˆ é™¤å¸¦ [drop] æ ‡è®°çš„åˆ—

å¦‚æœä½¿ç”¨é»˜è®¤æ¨¡å¼ï¼ˆ`auto_drop=False`ï¼‰å¤„ç†æ•°æ®ï¼Œæ‰€æœ‰ä¸ç¬¦åˆè¦æ±‚çš„åˆ—éƒ½ä¼šè¢«æ ‡è®°ä¸º `[drop]` ä½†ä¿ç•™åœ¨è¾“å‡ºä¸­ã€‚å¯ä»¥ä½¿ç”¨ä»¥ä¸‹å‘½ä»¤æ‰¹é‡åˆ é™¤è¿™äº›åˆ—ï¼š

```bash
# é¢„è§ˆåˆ é™¤æ‰€æœ‰å¸¦ [drop] æ ‡è®°çš„åˆ—
python -m timebench.preprocess \
    --remove_drop_marked \
    --target_dir ./data/processed_csv/IMOS/15T \
    --dry_run

# å®é™…æ‰§è¡Œåˆ é™¤
python -m timebench.preprocess \
    --remove_drop_marked \
    --target_dir ./data/processed_csv/IMOS/15T
```

è¯¥å‘½ä»¤ä¼šï¼š
- ä»æ‰€æœ‰ CSV æ–‡ä»¶ä¸­åˆ é™¤å¸¦ `[drop]` æ ‡è®°çš„åˆ—
- æ›´æ–°å¯¹åº”çš„ JSON æ–‡ä»¶ï¼ˆç§»é™¤ç›¸å…³è®°å½•ï¼Œæ›´æ–° `num_observations` ç­‰ç»Ÿè®¡ä¿¡æ¯ï¼‰
- æ›´æ–° `_summary.json` æ±‡æ€»æ–‡ä»¶

### ä½¿ç”¨ `--dry_run` é¢„è§ˆ

åœ¨æ‰§è¡Œåˆ é™¤æ“ä½œå‰ï¼Œå»ºè®®å…ˆä½¿ç”¨ `--dry_run` é¢„è§ˆï¼š

```bash
# é¢„è§ˆåˆ é™¤ variate
python -m timebench.preprocess --remove_variate TURB --target_dir ./data/processed_csv/IMOS/15T --dry_run

# è¾“å‡ºï¼š
# [DRY RUN] ä»æ•°æ®é›†ä¸­ç§»é™¤ variate: TURB
#   item_0.csv: ç§»é™¤åˆ— ['TURB']
#   item_1.csv: ç§»é™¤åˆ— ['TURB[rw]']
#   ...
# å°†ä¿®æ”¹ 8/8 ä¸ª CSV æ–‡ä»¶
# æç¤º: ç§»é™¤ --dry_run å‚æ•°ä»¥å®é™…æ‰§è¡Œä¿®æ”¹
```


---

## 7. ä¸‹ä¸€æ­¥

é¢„å¤„ç†å®Œæˆåï¼š

1. æŸ¥çœ‹ `_summary.json`ï¼ˆå¤š series æ•°æ®é›†ï¼‰æˆ–å•ä¸ª JSON æ–‡ä»¶äº†è§£æ•°æ®é›†ç»Ÿè®¡æƒ…å†µ
2. æ ¹æ®ç»Ÿè®¡ç»“æœå†³å®šæ˜¯å¦åˆ é™¤æŸäº› variate æˆ– seriesï¼ˆä½¿ç”¨ `--remove_variate` æˆ– `--remove_series`ï¼‰
3. å¦‚æœä½¿ç”¨é»˜è®¤æ¨¡å¼ï¼ˆ`auto_drop=False`ï¼‰ï¼Œå¯ä»¥ä½¿ç”¨ `--remove_drop_marked` æ‰¹é‡åˆ é™¤æ‰€æœ‰å¸¦ `[drop]` æ ‡è®°çš„åˆ—
4. å‚è€ƒ [DATA_FORMAT.md](./DATA_FORMAT.md) å°†æ¸…æ´—åçš„æ•°æ®è½¬æ¢ä¸º Arrow æ ¼å¼
5. å‚è€ƒ [PRED_CONFIG.md](./PRED_CONFIG.md) é…ç½®é¢„æµ‹ä»»åŠ¡å‚æ•°
6. å‚è€ƒç›¸å…³æ–‡æ¡£å¯¹æ¸…æ´—åçš„æ•°æ®è®¡ç®— tsfeature
